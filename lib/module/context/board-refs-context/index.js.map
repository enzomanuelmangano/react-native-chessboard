{"version":3,"names":["React","createContext","useCallback","useImperativeHandle","useRef","getChessboardState","useChessEngine","useSetBoard","PieceRefsContext","SquareRefsContext","BoardRefsContextProviderComponent","forwardRef","ref","children","chess","board","setBoard","generateBoardRefs","acc","x","length","row","y","col","String","fromCharCode","Math","round","square","pieceRefs","squareRefs","move","from","to","current","moveTo","highlight","color","backgroundColor","resetAllHighlightedSquares","reset","getState","resetBoard","fen","load","BoardRefsContextProvider","memo"],"sources":["index.tsx"],"sourcesContent":["import type { Move, Square } from 'chess.js';\r\nimport React, {\r\n  createContext,\r\n  useCallback,\r\n  useImperativeHandle,\r\n  useRef,\r\n} from 'react';\r\nimport {\r\n  ChessboardState,\r\n  getChessboardState,\r\n} from '../../helpers/get-chessboard-state';\r\nimport type { ChessPieceRef } from '../../components/piece';\r\nimport type { HighlightedSquareRefType } from '../../components/highlighted-squares/highlighted-square';\r\n\r\nimport { useChessEngine } from '../chess-engine-context/hooks';\r\nimport { useSetBoard } from '../board-context/hooks';\r\n\r\nconst PieceRefsContext = createContext<React.MutableRefObject<Record<\r\n  Square,\r\n  React.MutableRefObject<ChessPieceRef>\r\n> | null> | null>(null);\r\n\r\nconst SquareRefsContext = createContext<React.MutableRefObject<Record<\r\n  Square,\r\n  React.MutableRefObject<HighlightedSquareRefType>\r\n> | null> | null>(null);\r\n\r\nexport type ChessboardRef = {\r\n  move: (_: {\r\n    from: Square;\r\n    to: Square;\r\n  }) => Promise<Move | undefined> | undefined;\r\n  highlight: (_: { square: Square; color?: string }) => void;\r\n  resetAllHighlightedSquares: () => void;\r\n  resetBoard: (fen?: string) => void;\r\n  getState: () => ChessboardState;\r\n};\r\n\r\nconst BoardRefsContextProviderComponent = React.forwardRef<\r\n  ChessboardRef,\r\n  { children?: React.ReactNode }\r\n>(({ children }, ref) => {\r\n  const chess = useChessEngine();\r\n  const board = chess.board();\r\n  const setBoard = useSetBoard();\r\n\r\n  // There must be a better way of doing this.\r\n  const generateBoardRefs = useCallback(() => {\r\n    let acc = {};\r\n    for (let x = 0; x < board.length; x++) {\r\n      const row = board[x];\r\n      for (let y = 0; y < row.length; y++) {\r\n        const col = String.fromCharCode(97 + Math.round(x));\r\n        // eslint-disable-next-line no-shadow\r\n        const row = `${8 - Math.round(y)}`;\r\n        const square = `${col}${row}` as Square;\r\n\r\n        // eslint-disable-next-line react-hooks/rules-of-hooks\r\n        acc = { ...acc, [square]: useRef(null) };\r\n      }\r\n    }\r\n    return acc as any;\r\n  }, [board]);\r\n\r\n  const pieceRefs: React.MutableRefObject<Record<\r\n    Square,\r\n    React.MutableRefObject<ChessPieceRef>\r\n  > | null> = useRef(generateBoardRefs());\r\n\r\n  const squareRefs: React.MutableRefObject<Record<\r\n    Square,\r\n    React.MutableRefObject<HighlightedSquareRefType>\r\n  > | null> = useRef(generateBoardRefs());\r\n\r\n  useImperativeHandle(\r\n    ref,\r\n    () => ({\r\n      move: ({ from, to }) => {\r\n        return pieceRefs?.current?.[from].current?.moveTo?.(to);\r\n      },\r\n      highlight: ({ square, color }) => {\r\n        squareRefs.current?.[square].current.highlight({\r\n          backgroundColor: color,\r\n        });\r\n      },\r\n      resetAllHighlightedSquares: () => {\r\n        for (let x = 0; x < board.length; x++) {\r\n          const row = board[x];\r\n          for (let y = 0; y < row.length; y++) {\r\n            const col = String.fromCharCode(97 + Math.round(x));\r\n            // eslint-disable-next-line no-shadow\r\n            const row = `${8 - Math.round(y)}`;\r\n            const square = `${col}${row}` as Square;\r\n            squareRefs.current?.[square].current.reset();\r\n          }\r\n        }\r\n      },\r\n      getState: () => {\r\n        return getChessboardState(chess);\r\n      },\r\n      resetBoard: (fen) => {\r\n        chess.reset();\r\n        if (fen) chess.load(fen);\r\n        setBoard(chess.board());\r\n      },\r\n    }),\r\n    [board, chess, setBoard]\r\n  );\r\n\r\n  return (\r\n    <PieceRefsContext.Provider value={pieceRefs}>\r\n      <SquareRefsContext.Provider value={squareRefs}>\r\n        {children}\r\n      </SquareRefsContext.Provider>\r\n    </PieceRefsContext.Provider>\r\n  );\r\n});\r\n\r\nconst BoardRefsContextProvider = React.memo(BoardRefsContextProviderComponent);\r\n\r\nexport { PieceRefsContext, SquareRefsContext, BoardRefsContextProvider };\r\n"],"mappings":"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"}