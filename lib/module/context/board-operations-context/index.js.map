{"version":3,"names":["React","createContext","useCallback","useImperativeHandle","useMemo","useSharedValue","getChessboardState","useReversePiecePosition","useSetBoard","useBoardPromotion","usePieceRefs","useChessEngine","useChessboardProps","BoardOperationsContext","BoardOperationsContextProviderComponent","forwardRef","ref","children","controller","chess","setBoard","pieceSize","onMove","onChessboardMoveCallback","colors","checkmateHighlight","toTranslation","selectableSquares","selectedSquare","showPromotionDialog","pieceRefs","turn","reset","value","resetAllHighlightedSquares","isPromoting","from","to","includes","val","x","Math","floor","y","piece","board","type","PAWN","color","WHITE","BLACK","findKing","length","row","col","String","fromCharCode","round","square","get","charAt","moveProgrammatically","promotionPiece","move","promotion","isCheckmate","in_checkmate","highlight","state","in_promotion","lastMove","current","enable","onSelect","onSelectPiece","validSquares","moves","map","splittedSquare","split","moveTo","BoardOperationsContextProvider","memo"],"sources":["index.tsx"],"sourcesContent":["import type { PieceType, Square } from 'chess.js';\r\nimport React, {\r\n  createContext,\r\n  useCallback,\r\n  useImperativeHandle,\r\n  useMemo,\r\n} from 'react';\r\nimport type Animated from 'react-native-reanimated';\r\nimport { useSharedValue } from 'react-native-reanimated';\r\nimport { getChessboardState } from '../../helpers/get-chessboard-state';\r\n\r\nimport { useReversePiecePosition } from '../../notation';\r\nimport { useSetBoard } from '../board-context/hooks';\r\nimport { useBoardPromotion } from '../board-promotion-context/hooks';\r\nimport type { ChessboardRef } from '../board-refs-context';\r\nimport { usePieceRefs } from '../board-refs-context/hooks';\r\nimport { useChessEngine } from '../chess-engine-context/hooks';\r\nimport { useChessboardProps } from '../props-context/hooks';\r\n\r\ntype BoardOperationsContextType = {\r\n  selectableSquares: Animated.SharedValue<Square[]>;\r\n  onMove: (from: Square, to: Square) => void;\r\n  onSelectPiece: (square: Square) => void;\r\n  moveTo: (to: Square) => void;\r\n  isPromoting: (from: Square, to: Square) => boolean;\r\n  selectedSquare: Animated.SharedValue<Square | null>;\r\n  turn: Animated.SharedValue<'w' | 'b'>;\r\n};\r\n\r\nconst BoardOperationsContext = createContext<BoardOperationsContextType>(\r\n  {} as any\r\n);\r\n\r\nexport type BoardOperationsRef = {\r\n  reset: () => void;\r\n};\r\n\r\nconst BoardOperationsContextProviderComponent = React.forwardRef<\r\n  BoardOperationsRef,\r\n  { controller?: ChessboardRef; children?: React.ReactNode }\r\n>(({ children, controller }, ref) => {\r\n  const chess = useChessEngine();\r\n  const setBoard = useSetBoard();\r\n  const {\r\n    pieceSize,\r\n    onMove: onChessboardMoveCallback,\r\n    colors: { checkmateHighlight },\r\n  } = useChessboardProps();\r\n  const { toTranslation } = useReversePiecePosition();\r\n  const selectableSquares = useSharedValue<Square[]>([]);\r\n  const selectedSquare = useSharedValue<Square | null>(null);\r\n  const { showPromotionDialog } = useBoardPromotion();\r\n  const pieceRefs = usePieceRefs();\r\n\r\n  const turn = useSharedValue(chess.turn());\r\n\r\n  useImperativeHandle(\r\n    ref,\r\n    () => ({\r\n      reset: () => {\r\n        selectableSquares.value = [];\r\n        controller?.resetAllHighlightedSquares();\r\n        turn.value = chess.turn();\r\n      },\r\n    }),\r\n    [chess, controller, selectableSquares, turn]\r\n  );\r\n\r\n  const isPromoting = useCallback(\r\n    (from: Square, to: Square) => {\r\n      if (!to.includes('8') && !to.includes('1')) return false;\r\n\r\n      const val = toTranslation(from);\r\n      const x = Math.floor(val.x / pieceSize);\r\n      const y = Math.floor(val.y / pieceSize);\r\n      const piece = chess.board()[y][x];\r\n\r\n      return (\r\n        piece?.type === chess.PAWN &&\r\n        ((to.includes('8') && piece.color === chess.WHITE) ||\r\n          (to.includes('1') && piece.color === chess.BLACK))\r\n      );\r\n    },\r\n    [chess, pieceSize, toTranslation]\r\n  );\r\n\r\n  const findKing = useCallback(\r\n    (type: 'wk' | 'bk') => {\r\n      const board = chess.board();\r\n      for (let x = 0; x < board.length; x++) {\r\n        const row = board[x];\r\n        for (let y = 0; y < row.length; y++) {\r\n          const col = String.fromCharCode(97 + Math.round(x));\r\n\r\n          // eslint-disable-next-line no-shadow\r\n          const row = `${8 - Math.round(y)}`;\r\n          const square = `${col}${row}` as Square;\r\n\r\n          const piece = chess.get(square);\r\n          if (piece?.color === type.charAt(0) && piece.type === type.charAt(1))\r\n            return square;\r\n        }\r\n      }\r\n      return null;\r\n    },\r\n    [chess]\r\n  );\r\n\r\n  const moveProgrammatically = useCallback(\r\n    (from: Square, to: Square, promotionPiece?: PieceType) => {\r\n      const move = chess.move({\r\n        from,\r\n        to,\r\n        promotion: promotionPiece as any,\r\n      });\r\n\r\n      turn.value = chess.turn();\r\n\r\n      if (move == null) return;\r\n\r\n      const isCheckmate = chess.in_checkmate();\r\n\r\n      if (isCheckmate) {\r\n        const square = findKing(`${chess.turn()}k`);\r\n        if (!square) return;\r\n        controller?.highlight({ square, color: checkmateHighlight });\r\n      }\r\n\r\n      onChessboardMoveCallback?.({\r\n        move,\r\n        state: {\r\n          ...getChessboardState(chess),\r\n          in_promotion: promotionPiece != null,\r\n        },\r\n      });\r\n\r\n      setBoard(chess.board());\r\n    },\r\n    [\r\n      checkmateHighlight,\r\n      chess,\r\n      controller,\r\n      findKing,\r\n      onChessboardMoveCallback,\r\n      setBoard,\r\n      turn,\r\n    ]\r\n  );\r\n\r\n  const onMove = useCallback(\r\n    (from: Square, to: Square) => {\r\n      selectableSquares.value = [];\r\n      selectedSquare.value = null;\r\n      const lastMove = { from, to };\r\n      controller?.resetAllHighlightedSquares();\r\n      controller?.highlight({ square: lastMove.from });\r\n      controller?.highlight({ square: lastMove.to });\r\n\r\n      const in_promotion = isPromoting(from, to);\r\n      if (!in_promotion) {\r\n        moveProgrammatically(from, to);\r\n        return;\r\n      }\r\n\r\n      pieceRefs?.current?.[to]?.current?.enable(false);\r\n      showPromotionDialog({\r\n        type: chess.turn(),\r\n        onSelect: (piece) => {\r\n          moveProgrammatically(from, to, piece);\r\n          pieceRefs?.current?.[to]?.current?.enable(true);\r\n        },\r\n      });\r\n    },\r\n    [\r\n      chess,\r\n      controller,\r\n      isPromoting,\r\n      moveProgrammatically,\r\n      pieceRefs,\r\n      selectableSquares,\r\n      selectedSquare,\r\n      showPromotionDialog,\r\n    ]\r\n  );\r\n\r\n  const onSelectPiece = useCallback(\r\n    (square: Square) => {\r\n      selectedSquare.value = square;\r\n\r\n      const validSquares = (chess.moves({\r\n        square,\r\n      }) ?? []) as Square[];\r\n\r\n      // eslint-disable-next-line no-shadow\r\n      selectableSquares.value = validSquares.map((square) => {\r\n        const splittedSquare = square.split('x');\r\n        if (splittedSquare.length === 0) {\r\n          return square;\r\n        }\r\n\r\n        return splittedSquare[splittedSquare.length - 1] as Square;\r\n      });\r\n    },\r\n    [chess, selectableSquares, selectedSquare]\r\n  );\r\n\r\n  const moveTo = useCallback(\r\n    (to: Square) => {\r\n      if (selectedSquare.value != null) {\r\n        controller?.move({ from: selectedSquare.value, to: to });\r\n        return true;\r\n      }\r\n      return false;\r\n    },\r\n    [controller, selectedSquare.value]\r\n  );\r\n\r\n  const value = useMemo(() => {\r\n    return {\r\n      onMove,\r\n      onSelectPiece,\r\n      moveTo,\r\n      selectableSquares,\r\n      selectedSquare,\r\n      isPromoting,\r\n      turn,\r\n    };\r\n  }, [\r\n    isPromoting,\r\n    moveTo,\r\n    onMove,\r\n    onSelectPiece,\r\n    selectableSquares,\r\n    selectedSquare,\r\n    turn,\r\n  ]);\r\n\r\n  return (\r\n    <BoardOperationsContext.Provider value={value}>\r\n      {children}\r\n    </BoardOperationsContext.Provider>\r\n  );\r\n});\r\n\r\nconst BoardOperationsContextProvider = React.memo(\r\n  BoardOperationsContextProviderComponent\r\n);\r\n\r\nexport { BoardOperationsContextProvider, BoardOperationsContext };\r\n"],"mappings":"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"}